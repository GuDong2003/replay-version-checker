name: Check Replay Version

on:
  # å®šæ—¶è¿è¡Œ: æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */4 * * *'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯æ—¶ä¹Ÿè¿è¡Œ(å¯é€‰)
  push:
    branches:
      - main
    paths:
      - 'check_all_platforms.py'
      - '.github/workflows/check-version.yml'

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦è·å–å®Œæ•´å†å²ä»¥ä¾¿æäº¤æ›´æ”¹
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run version check
        id: version_check
        run: |
          python check_all_platforms.py

      - name: Commit version file if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if [[ -f all_platforms_versions.json ]]; then
            # å…ˆæ‹‰å–æœ€æ–°ä»£ç 
            git fetch origin main
            git reset --hard origin/main

            # é‡æ–°è¿è¡Œæ£€æŸ¥ä»¥è·å–æœ€æ–°ç‰ˆæœ¬
            python check_all_platforms.py

            # å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            git add all_platforms_versions.json

            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              # æäº¤å˜åŒ–
              git commit -m "chore: update Replay version info [skip ci]"

              # æ¨é€,å¦‚æœå¤±è´¥å°±æ”¾å¼ƒ(å¯èƒ½å…¶ä»–å·¥ä½œæµå·²ç»æ¨é€äº†)
              git push || echo "Push failed, but continuing workflow..."
            fi
          fi

      - name: Create Issue on new version
        if: steps.version_check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const updatesJson = process.env.UPDATES_JSON;
            const updates = JSON.parse(updatesJson || '[]');

            if (updates.length === 0) {
              console.log('No updates to report');
              return;
            }

            for (const update of updates) {
              const title = `ğŸš€ ${update.platform} æ–°ç‰ˆæœ¬ ${update.new_version}`;

              let body = `## ğŸ‰ æ£€æµ‹åˆ° ${update.platform} æ–°ç‰ˆæœ¬\n\n`;
              body += `- æ—§ç‰ˆæœ¬: ${update.old_version}\n`;
              body += `- æ–°ç‰ˆæœ¬: ${update.new_version}\n`;
              body += `- å®˜ç½‘ä¸‹è½½: https://www.weights.com/replay?platform=${update.download_param}\n`;
              if (update.download_url) {
                body += `- ç›´æ¥ä¸‹è½½: ${update.download_url}\n`;
              }
              body += `\n---\n\n`;
              body += `æ£€æµ‹æ—¶é—´: ${new Date().toISOString()}\n\n`;
              body += `æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºã€‚`;

              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                labels: 'version-update',
                per_page: 100
              });

              const existingIssue = issues.data.find(issue =>
                issue.title.includes(update.platform) && issue.title.includes(update.new_version)
              );

              if (!existingIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['version-update', 'automated', update.platform_key]
                });

                console.log(`âœ… Issue created for ${update.platform}: ${update.new_version}`);
              } else {
                console.log(`â„¹ï¸ Issue already exists for ${update.platform} ${update.new_version}`);
              }
            }
        env:
          UPDATES_JSON: ${{ steps.version_check.outputs.updates_json }}

      - name: Send Feishu notification
        if: steps.version_check.outputs.has_updates == 'true'
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK_URL }}
          UPDATES_JSON: ${{ steps.version_check.outputs.updates_json }}
        run: |
          if [ -z "$FEISHU_WEBHOOK" ]; then
            echo "âš ï¸  FEISHU_WEBHOOK_URL æœªé…ç½®ï¼Œè·³è¿‡é£ä¹¦é€šçŸ¥"
            exit 0
          fi

          # è§£ææ›´æ–°ä¿¡æ¯
          UPDATES=$(echo "$UPDATES_JSON" | jq -r '.[] | "**\(.platform)**\næ—§ç‰ˆæœ¬: `\(.old_version)`\næ–°ç‰ˆæœ¬: `\(.new_version)`\n[å®˜ç½‘ä¸‹è½½](https://www.weights.com/replay?platform=\(.download_param))\n"')

          # æ„å»ºé£ä¹¦æ¶ˆæ¯å¡ç‰‡
          TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

          cat > /tmp/feishu_message.json << EOF
          {
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "ğŸ‰ Replay æ–°ç‰ˆæœ¬æ›´æ–°é€šçŸ¥"
                },
                "template": "blue"
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "æ£€æµ‹åˆ°ä»¥ä¸‹å¹³å°æœ‰æ–°ç‰ˆæœ¬å‘å¸ƒï¼š"
                  }
                },
                {
                  "tag": "hr"
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "$(echo "$UPDATES_JSON" | jq -r '[.[] | "**" + .platform + "**\n- æ—§ç‰ˆæœ¬: `" + .old_version + "`\n- æ–°ç‰ˆæœ¬: `" + .new_version + "`\n- [å®˜ç½‘ä¸‹è½½](https://www.weights.com/replay?platform=" + .download_param + ")" + (if .download_url != "" then "\n- [ç›´æ¥ä¸‹è½½](" + .download_url + ")" else "" end)] | join("\n\n")')"
                  }
                },
                {
                  "tag": "hr"
                },
                {
                  "tag": "note",
                  "elements": [
                    {
                      "tag": "plain_text",
                      "content": "æ£€æµ‹æ—¶é—´: ${TIMESTAMP}"
                    }
                  ]
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "tag": "plain_text",
                        "content": "æŸ¥çœ‹è¯¦æƒ…"
                      },
                      "type": "primary",
                      "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
          }
          EOF

          # å‘é€åˆ°é£ä¹¦
          HTTP_CODE=$(curl -s -o /tmp/feishu_response.txt -w "%{http_code}" \
            -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @/tmp/feishu_message.json)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… é£ä¹¦é€šçŸ¥å‘é€æˆåŠŸ"
            cat /tmp/feishu_response.txt
          else
            echo "âŒ é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥ (HTTP $HTTP_CODE)"
            cat /tmp/feishu_response.txt
            exit 1
          fi