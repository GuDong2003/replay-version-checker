name: Check Replay Version

on:
  # å®šæ—¶è¿è¡Œ: æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */4 * * *'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯æ—¶ä¹Ÿè¿è¡Œ(å¯é€‰)
  push:
    branches:
      - main
    paths:
      - 'check_all_platforms.py'
      - '.github/workflows/check-version.yml'

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦è·å–å®Œæ•´å†å²ä»¥ä¾¿æäº¤æ›´æ”¹
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run version check
        id: version_check
        run: |
          python check_all_platforms.py

      - name: Commit version file if changed
        id: commit_check
        continue-on-error: true
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if [[ -f all_platforms_versions.json ]]; then
            # å…ˆä¿å­˜å½“å‰ç”Ÿæˆçš„ç‰ˆæœ¬æ–‡ä»¶
            cp all_platforms_versions.json /tmp/new_version.json

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "Pulling latest changes..."
            git fetch origin main || {
              echo "Fetch failed, skipping commit"
              echo "version_updated=false" >> $GITHUB_OUTPUT
              exit 0
            }

            # é‡ç½®åˆ°è¿œç¨‹æœ€æ–°ç‰ˆæœ¬
            git reset --hard origin/main

            # æ£€æŸ¥æ–°ç”Ÿæˆçš„ç‰ˆæœ¬æ–‡ä»¶ä¸è¿œç¨‹æ˜¯å¦æœ‰å·®å¼‚
            if diff -q all_platforms_versions.json /tmp/new_version.json > /dev/null 2>&1; then
              echo "No changes detected (files are identical)"
              echo "version_updated=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            # æ¢å¤æ–°ç”Ÿæˆçš„ç‰ˆæœ¬æ–‡ä»¶
            cp /tmp/new_version.json all_platforms_versions.json
            git add all_platforms_versions.json

            # æäº¤å˜åŒ–
            git commit -m "chore: update Replay version info [skip ci]" || {
              echo "Commit failed, skipping"
              echo "version_updated=false" >> $GITHUB_OUTPUT
              exit 0
            }

            # æ¨é€åˆ°è¿œç¨‹,å¦‚æœå¤±è´¥å°±æ”¾å¼ƒ(é¿å…é‚®ä»¶é€šçŸ¥)
            if ! git push origin main 2>/dev/null; then
              echo "Push failed (likely another workflow pushed first). This is expected, skipping."
              echo "version_updated=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "Successfully pushed version update"
            echo "version_updated=true" >> $GITHUB_OUTPUT
          else
            echo "version_updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue on new version
        if: steps.version_check.outputs.has_updates == 'true' && steps.commit_check.outputs.version_updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const updatesJson = process.env.UPDATES_JSON;
            const updates = JSON.parse(updatesJson || '[]');

            if (updates.length === 0) {
              console.log('No updates to report');
              return;
            }

            for (const update of updates) {
              const title = `ğŸš€ ${update.platform} æ–°ç‰ˆæœ¬ ${update.new_version}`;

              let body = `## ğŸ‰ æ£€æµ‹åˆ° ${update.platform} æ–°ç‰ˆæœ¬\n\n`;
              body += `- æ—§ç‰ˆæœ¬: ${update.old_version}\n`;
              body += `- æ–°ç‰ˆæœ¬: ${update.new_version}\n`;
              body += `- å®˜ç½‘ä¸‹è½½: https://www.weights.com/replay?platform=${update.download_param}\n`;
              if (update.download_url) {
                body += `- ç›´æ¥ä¸‹è½½: ${update.download_url}\n`;
              }
              body += `\n---\n\n`;
              body += `æ£€æµ‹æ—¶é—´: ${new Date().toISOString()}\n\n`;
              body += `æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºã€‚`;

              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                labels: 'version-update',
                per_page: 100
              });

              const existingIssue = issues.data.find(issue =>
                issue.title.includes(update.platform) && issue.title.includes(update.new_version)
              );

              if (!existingIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['version-update', 'automated', update.platform_key]
                });

                console.log(`âœ… Issue created for ${update.platform}: ${update.new_version}`);
              } else {
                console.log(`â„¹ï¸ Issue already exists for ${update.platform} ${update.new_version}`);
              }
            }
        env:
          UPDATES_JSON: ${{ steps.version_check.outputs.updates_json }}

      - name: Send Feishu notification
        if: steps.version_check.outputs.has_updates == 'true' && steps.commit_check.outputs.version_updated == 'true'
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          UPDATES_JSON: ${{ steps.version_check.outputs.updates_json }}
        run: |
          if [ -z "$FEISHU_WEBHOOK_URL" ]; then
            echo "âš ï¸  FEISHU_WEBHOOK_URL æœªé…ç½®ï¼Œè·³è¿‡é£ä¹¦é€šçŸ¥"
            exit 0
          fi

          # æ„å»ºé£ä¹¦æ¶ˆæ¯å¡ç‰‡
          TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

          # ç”Ÿæˆæ¯ä¸ªå¹³å°çš„æ›´æ–°å…ƒç´ 
          PLATFORM_ELEMENTS=$(echo "$UPDATES_JSON" | jq -c '.[]' | while IFS= read -r update; do
            platform=$(echo "$update" | jq -r '.platform')
            old_version=$(echo "$update" | jq -r '.old_version')
            new_version=$(echo "$update" | jq -r '.new_version')
            download_param=$(echo "$update" | jq -r '.download_param')
            download_url=$(echo "$update" | jq -r '.download_url // ""')

            # æ„å»ºä¸‹è½½é“¾æ¥éƒ¨åˆ†
            if [ -n "$download_url" ]; then
              download_links="[å®˜ç½‘ä¸‹è½½](https://www.weights.com/replay?platform=${download_param}) | [ç›´æ¥ä¸‹è½½](${download_url})"
            else
              download_links="[å®˜ç½‘ä¸‹è½½](https://www.weights.com/replay?platform=${download_param})"
            fi

            # è¾“å‡ºå¹³å°å¡ç‰‡å…ƒç´  (ä½¿ç”¨ jq æ„å»º JSON)
            jq -n --arg platform "$platform" \
                  --arg old_ver "$old_version" \
                  --arg new_ver "$new_version" \
                  --arg links "$download_links" \
                  '{
                    tag: "div",
                    text: {
                      tag: "lark_md",
                      content: ("**" + $platform + "**\nğŸ”„ " + $old_ver + " â†’ " + $new_ver + "\nğŸ“¥ " + $links)
                    }
                  }'
            echo '{"tag":"hr"}'
          done | jq -s '.')  # å°†æ‰€æœ‰å…ƒç´ åˆå¹¶ä¸ºæ•°ç»„

          # æ„å»ºå®Œæ•´æ¶ˆæ¯ (ä½¿ç”¨ jq)
          GITHUB_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "$PLATFORM_ELEMENTS" | jq --arg ts "$TIMESTAMP" --arg url "$GITHUB_URL" '{
            msg_type: "interactive",
            card: {
              header: {
                title: {
                  tag: "plain_text",
                  content: "ğŸ‰ Replay æ–°ç‰ˆæœ¬æ›´æ–°é€šçŸ¥"
                },
                template: "blue"
              },
              elements: ([
                {
                  tag: "div",
                  text: {
                    tag: "lark_md",
                    content: "æ£€æµ‹åˆ°ä»¥ä¸‹å¹³å°æœ‰æ–°ç‰ˆæœ¬å‘å¸ƒï¼š"
                  }
                },
                {
                  tag: "hr"
                }
              ] + (.[0:length-1]) + [
                {
                  tag: "note",
                  elements: [
                    {
                      tag: "plain_text",
                      content: ("æ£€æµ‹æ—¶é—´: " + $ts)
                    }
                  ]
                },
                {
                  tag: "action",
                  actions: [
                    {
                      tag: "button",
                      text: {
                        tag: "plain_text",
                        content: "æŸ¥çœ‹è¯¦æƒ…"
                      },
                      type: "primary",
                      url: $url
                    }
                  ]
                }
              ])
            }
          }' > /tmp/feishu_message.json

          # å‘é€åˆ°é£ä¹¦
          HTTP_CODE=$(curl -s -o /tmp/feishu_response.txt -w "%{http_code}" \
            -X POST "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @/tmp/feishu_message.json)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… é£ä¹¦é€šçŸ¥å‘é€æˆåŠŸ"
            cat /tmp/feishu_response.txt
          else
            echo "âŒ é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥ (HTTP $HTTP_CODE)"
            cat /tmp/feishu_response.txt
            exit 1
          fi